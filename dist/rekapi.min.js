/**
 * Rekapi - Rewritten Kapi. v0.5.1
 *   By Jeremy Kahn - jeremyckahn@gmail.com
 *   https://github.com/jeremyckahn/rekapi
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore), Shifty.js (https://github.com/jeremyckahn/shifty)
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(e){function j(b){return b.sort(function(b,a){return b-a})}function g(b,a){return Math.floor(a/b._animationLength)}function i(b){return f()-b._loopTimestamp}function k(b,a){return a>=b._timesToIterate&&-1!==b._timesToIterate}function m(b,c){k(b,c)&&(b.stop(),a(b,"onAnimationComplete"))}function n(b,a,c){return k(b,c)?b._animationLength:a%b._animationLength}function h(b){var a=i(b),c;c=g(b,a);a=n(b,a,c);b.render(a);m(b,c)}function l(b){b._loopId=setTimeout(function(){l(b);h(b)},1E3/b.config.fps)}
function a(b,a){_.each(b._events[a],function(a){a(b)})}var d={fps:30,height:150,width:300,doRoundNumbers:!1,clearOnUpdate:!0},f=Tweenable.util.now,c=e.Kapi||function(b,a){this.canvas=b;this._contextType=null;this.canvas_setContext(b);this.config={};this._actors={};this._drawOrder=[];this._playState="stopped";this._drawOrderSorter=null;this._events={onFrameRender:[],onAnimationComplete:[],onPlayStateChange:[],onPlay:[],onPause:[],onStop:[]};this._timesToIterate=-1;this._animationLength=0;this._pausedAtTime=
this._loopTimestamp=this._loopId=null;this._lastRenderedMillisecond=0;_.extend(this.config,a);_.defaults(this.config,d);_.each(["height","width"],function(b){this.config[b]&&(this["canvas_"+b](this.config[b]),delete this.config[b])},this);return this};c.prototype.addActor=function(b){if(!_.contains(this._actors,b))b.kapi=this,b.fps=this.framerate(),this._actors[b.id]=b,this._drawOrder.push(b.id),b.setup();return this};c.prototype.getActor=function(b){return this._actors[b]};c.prototype.getActorIds=
function(){return _.pluck(this._actors,"id")};c.prototype.getAllActors=function(){return _.clone(this._actors)};c.prototype.removeActor=function(b){delete this._actors[b.id];delete b.kapi;this._drawOrder=_.without(this._drawOrder,b.id);b.teardown();this.updateInternalState();return this};c.prototype.play=function(b){clearTimeout(this._loopId);this._loopTimestamp="paused"===this._playState?this._loopTimestamp+(f()-this._pausedAtTime):f();this._timesToIterate=b||-1;this._playState="playing";l(this);
_.each(this._actors,function(b){b._state.isPaused&&b.resume()});a(this,"onPlayStateChange");a(this,"onPlay");return this};c.prototype.playFrom=function(b,a){this.play(a);this._loopTimestamp=f()-b;return this};c.prototype.playFromCurrent=function(b){return this.playFrom(this._lastRenderedMillisecond,b)};c.prototype.pause=function(){if("paused"===this._playState)return this;this._playState="paused";clearTimeout(this._loopId);this._pausedAtTime=f();_.each(this._actors,function(b){b._state.isTweening&&
b.pause()});a(this,"onPlayStateChange");a(this,"onPause");return this};c.prototype.stop=function(b){this._playState="stopped";clearTimeout(this._loopId);!0===b&&this.canvas_clear();_.each(this._actors,function(a){a.stop();!0===b&&a.hide()});a(this,"onPlayStateChange");a(this,"onStop");return this};c.prototype.isPlaying=function(){return"playing"===this._playState};c.prototype.animationLength=function(){return this._animationLength};c.prototype.lastPositionRendered=function(){return this._lastRenderedMillisecond/
this._animationLength};c.prototype.actorCount=function(){return this._drawOrder.length};c.prototype.framerate=function(b){if(b)this.config.fps=b;return this.config.fps};c.prototype.render=function(b){this.calculateActorPositions(b);this.draw();this._lastRenderedMillisecond=b;a(this,"onFrameRender");return this};c.prototype.redraw=function(){this.render(this._lastRenderedMillisecond);return this};c.prototype.calculateActorPositions=function(b){var a,c,d;d=Tweenable.util.isRoundingEnabled();this.config.doRoundNumbers?
Tweenable.util.enableRounding():Tweenable.util.disableRounding();c=this._drawOrder.length;for(a=0;a<c;a++)this._actors[this._drawOrder[a]].calculatePosition(b);!0===d?Tweenable.util.enableRounding():Tweenable.util.disableRounding();return this};c.prototype.draw=function(){var a,c,d,f,g;this.config.clearOnUpdate&&this.canvas_clear();c=this._drawOrder.length;f=this.canvas_getContext();this._drawOrderSorter?(a=_.sortBy(this._actors,this._drawOrderSorter),g=_.pluck(a,"id")):g=this._drawOrder;for(a=0;a<
c;a++)d=this._actors[g[a]],d.isShowing()&&d.draw(f,d.get());return this};c.prototype.updateInternalState=function(){var a=[];_.each(this._actors,function(c){a.push(c.getEnd())});this._animationLength=Math.max.apply(Math,a);return this};c.prototype.moveActorToLayer=function(a,c){if(c<this._drawOrder.length)return this._drawOrder=_.without(this._drawOrder,a.id),this._drawOrder.splice(c,0,a.id),a};c.prototype.bind=function(a,c){if(this._events[a])return this._events[a].push(c),this};c.prototype.unbind=
function(a,c){if(this._events[a])return this._events[a]=c?_.without(this._events[a],c):[],this};c.prototype.setOrderFunction=function(a){this._drawOrderSorter=a;return this};c.prototype.unsetOrderFunction=function(){this._drawOrderSorter=null;return this};c.prototype.exportTimeline=function(){var a={duration:this._animationLength,actorOrder:this._drawOrder.slice(0),actors:{}};_.each(this._drawOrder,function(c){a.actors[c]=this._actors[c].exportTimeline()},this);return a};c.util={};_.extend(c.util,
{noop:function(){},sortNumerically:j,calculateLoopPosition:n,calculateTimeSinceStart:i});if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)c._private={sortNumerically:j,calculateLoopPosition:n,renderCurrentMillisecond:h,tick:l,determineCurrentLoopIteration:g,calculateTimeSinceStart:i,isAnimationComplete:k,updatePlayState:m};e.Rekapi=e.Kapi=c})(this);
(function(e){function j(a,d){var f,c,b;b=a._timelinePropertyCacheIndex;c=b.length;for(f=1;f<c;f++)if(b[f]>=d)return f-1;return-1}function g(a){_.each(a._propertyTracks,function(d,f){a._propertyTracks[f]=_.sortBy(a._propertyTracks[f],function(a){return a.millisecond})})}function i(a){_.each(a._timelinePropertyCaches,function(d,f){var c={};_.each(a._propertyTracks,function(a,d){var g=null;_.find(a,function(a){a.millisecond>f&&(c[d]=g);g=a;return!!c[d]})});_.defaults(d,c)})}function k(a){_.each(a._propertyTracks,
function(a){_.each(a,function(f,c){f.linkToNext(a[c+1])})})}function m(a,d,f){return _.find(a._propertyTracks[d],function(a){return a.millisecond===f})}function n(a,d,f,c){var b=_.keys(a._propertyTracks),g=_.keys(d),b=_.difference(b,g),h={};_.each(b,function(b){var d;d=a._propertyTracks[b].slice(0).reverse();_.each(d,function(a){a.millisecond<c&&!h[b]&&(h[b]={value:a.value,easing:a.easing})})});_.each(h,function(a,b){d[b]=a.value;f[b]=a.easing})}var h,l;h=e.Kapi;l=0;h.Actor=function(a){a=a||{};this.constructor.call(this);
_.extend(this,{_data:{},_propertyTracks:{},_timelinePropertyCaches:{},_timelinePropertyCacheIndex:[],_keyframeProperties:{},_isShowing:!1,_isPersisting:!1,id:l++,setup:a.setup||h.util.noop,draw:a.draw||h.util.noop,teardown:a.teardown||h.util.noop});return this};e=function(){};e.prototype=Tweenable.prototype;h.Actor.prototype=new e;h.Actor.prototype.keyframe=function(a,d,f){var c;f||(f="linear");"string"===typeof f&&(c=f,f={},_.each(d,function(a,d){f[d]=c}));_.each(d,function(a,c){f[c]=f[c]||"linear"});
n(this,d,f,a);_.each(d,function(b,c){var d;d=new h.KeyframeProperty(this,a,c,b,f[c]);this._keyframeProperties[d.id]=d;this._propertyTracks[c]||(this._propertyTracks[c]=[]);this._propertyTracks[c].push(d);g(this)},this);this.kapi.updateInternalState();this.invalidatePropertyCache();return this};h.Actor.prototype.getKeyframeProperty=function(a,d){if(this._propertyTracks[a]&&this._propertyTracks[a][d])return this._propertyTracks[a][d]};h.Actor.prototype.modifyKeyframeProperty=function(a,d,f){this._propertyTracks[a]&&
this._propertyTracks[a][d]&&this._propertyTracks[a][d].modifyWith(f);g(this);this.invalidatePropertyCache();return this};h.Actor.prototype.getTrackNames=function(){return _.keys(this._propertyTracks)};h.Actor.prototype.getTrackLength=function(a){return!this._propertyTracks[a]?void 0:this._propertyTracks[a].length};h.Actor.prototype.copyProperties=function(a,d){var f,c;f={};c={};_.each(this._propertyTracks,function(a,g){var h;if(h=m(this,g,d))f[g]=h.value,c[g]=h.easing},this);this.keyframe(a,f,c);
return this};h.Actor.prototype.wait=function(a){var d=this.getEnd();if(a<=d)return this;this.copyProperties(a,d);return this};h.Actor.prototype.getStart=function(){var a=[];_.each(this._propertyTracks,function(d){d.length&&a.push(d[0].millisecond)});0===a.length&&(a=[0]);return Math.min.apply(Math,a)};h.Actor.prototype.getEnd=function(){var a=0;_.each(this._propertyTracks,function(d){if(d.length)d=_.last(d).millisecond,d>a&&(a=d)},this);return a};h.Actor.prototype.getLength=function(){return this.getEnd()-
this.getStart()};h.Actor.prototype.modifyKeyframe=function(a,d,f){f=f||{};_.each(this._propertyTracks,function(c,b){var g=m(this,b,a);g&&g.modifyWith({value:d[b],easing:f[b]})},this);return this};h.Actor.prototype.removeKeyframe=function(a){_.each(this._propertyTracks,function(d){var f=-1;_.find(d,function(c){f++;return a===c.millisecond});(d=d.splice(f,1)[0])&&delete this._keyframeProperties[d.id]},this);this.kapi.updateInternalState();this.invalidatePropertyCache();return this};h.Actor.prototype.removeAllKeyframeProperties=
function(){_.each(this._propertyTracks,function(a){a.length=0},this);this._keyframeProperties={};return this.removeKeyframe(0)};h.Actor.prototype.moveToLayer=function(a){return this.kapi.moveActorToLayer(this,a)};h.Actor.prototype.show=function(a){this._isShowing=!0;this._isPersisting=!!a;return this};h.Actor.prototype.hide=function(a){this._isShowing=!1;if(!0===a)this._isPersisting=!1;return this};h.Actor.prototype.isShowing=function(){return this._isShowing||this._isPersisting};h.Actor.prototype.calculatePosition=
function(a){var d,f,c;d=this.getStart();f=this.getEnd();this.hide();d<=a&&a<=f&&(this.show(),d=j(this,a),d=this._timelinePropertyCaches[this._timelinePropertyCacheIndex[d]],c={},_.each(d,function(b,d){c[d]=b.getValueAt(a)}),this.set(c));return this};h.Actor.prototype.data=function(a){if(a)this._data=a;return this._data};h.Actor.prototype.exportTimeline=function(){var a={start:this.getStart(),end:this.getEnd(),trackNames:this.getTrackNames(),propertyTracks:{}};_.each(this._propertyTracks,function(d,
f){var c=a.propertyTracks[f]=[];_.each(d,function(a){c.push(a.exportPropertyData())})});return a};h.Actor.prototype.invalidatePropertyCache=function(){this._timelinePropertyCaches={};_.each(this._keyframeProperties,function(a){this._timelinePropertyCaches[a.millisecond]||(this._timelinePropertyCaches[a.millisecond]={});this._timelinePropertyCaches[a.millisecond][a.name]=a},this);this._timelinePropertyCacheIndex=_.keys(this._timelinePropertyCaches);_.each(this._timelinePropertyCacheIndex,function(a,
d){this._timelinePropertyCacheIndex[d]=+a},this);h.util.sortNumerically(this._timelinePropertyCacheIndex);i(this);k(this)};_.each(["tween","to"],function(a){h.Actor.prototype[a]=function(){this.show(!0);Tweenable.prototype[a].apply(this,arguments)}},this)})(this);
(function(e){function j(g,i,e,j){if("undefined"!==typeof j){g[e]=j;if(!g.style)g.style={};g.style[e]=j+"px"}return i===i.HTML_ELEMENT?g.style[e]:g[e]}e=e.Kapi;e.prototype.canvas_setContext=function(g){var e;this._canvas=g;e=g.nodeName;void 0===e?(this._context={},this._contextType="other"):"CANVAS"===e?(this._context=g.getContext("2d"),this._contextType="canvas"):(this._context=g,this._contextType="HTMLElement");return this.canvas_getContext()};e.prototype.canvas_getContext=function(){return this._context};
e.prototype.canvas_height=function(g){return j(this.canvas,this._contextType,"height",g)};e.prototype.canvas_width=function(g){return j(this.canvas,this._contextType,"width",g)};e.prototype.canvas_style=function(g,e){"undefined"!==typeof e&&this.canvas.style&&(this.canvas.style[g]=e);return this.canvas.style[g]};e.prototype.canvas_clear=function(){"canvas"===this._contextType&&this.canvas_getContext().clearRect(0,0,this.canvas_width(),this.canvas_height());return this}})(this);
(function(e){e=e.Kapi;e.KeyframeProperty=function(e,g,i,k,m){this.id=_.uniqueId("keyframeProperty_");this.ownerActor=e;this.millisecond=g;this.name=i;this.value=k;this.easing=m||"linear";this.nextProperty=null;return this};e.KeyframeProperty.prototype.modifyWith=function(e){var g={};_.each(["millisecond","easing","value"],function(i){g[i]="undefined"===typeof e[i]?this[i]:e[i]},this);_.extend(this,g)};e.KeyframeProperty.prototype.linkToNext=function(e){this.nextProperty=e||null};e.KeyframeProperty.prototype.getValueAt=
function(e){var g,i,k;g={};i={};this.nextProperty?(g[this.name]=this.value,i[this.name]=this.nextProperty.value,k=this.nextProperty.millisecond-this.millisecond,e=(e-this.millisecond)/k,g=Tweenable.util.interpolate(g,i,e,this.nextProperty.easing)[this.name]):g=null;return g};e.KeyframeProperty.prototype.exportPropertyData=function(){return{id:this.id,millisecond:this.millisecond,name:this.name,value:this.value,easing:this.easing}}})(this);
(function(e){var j=e.Kapi,g=["transform","webkitTransform","MozTransform","oTransform","msTransform"];if(e.getComputedStyle)j.DOMActor=function(i){var k;k=new j.Actor({setup:function(){var g=this.kapi.canvas_getContext();"static"===e.getComputedStyle(g).getPropertyValue("position")&&(this.kapi.canvas_getContext().style.position="relative");"static"===e.getComputedStyle(i).getPropertyValue("position")&&(i.style.position="absolute");this.hide()},draw:function(e,j){var h;h=!1;_.each(j,function(e,a){h=
!0;"rotate"===a?_.each(g,function(a){i.style[a]="rotate("+e+"deg)"}):i.style[a]=e});h?this.show():this.hide()}});i.classList.add(k.getCSSName());k.show=function(e){j.Actor.prototype.show.call(this,e);i.style.display="block"};k.hide=function(e){j.Actor.prototype.hide.call(this,e);i.style.display="none"};return k},e.Kapi.Actor.prototype.getCSSName=function(){return"actor-"+this.id}})(this);
(function(e,j){function g(a){var d=["{"],f;_.each(a.get(),function(a,b){var e;/rgb/.test(a)?e=a:(e=a.match(/\D*$/),e=parseFloat(a).toFixed(2)+e);f=e;d.push(b+":"+f+";")});d.push("}");return d.join("")}function i(a,d,f){var f=f||["w3"],c=[];_.each(f,function(b){b=l(n,[m[b],d,a]);c.push(b)});return c.join("\n")}function k(a,d){var d=d||["w3"],f=[],c;_.each(d,function(b){var d=[],b=m[b],e=a.getStart(),g=a.getEnd()-e,g=l("  %sanimation-duration: %sms;",[b,g]);d.push(g);g=l("  %sanimation-name: %s;",[b,
a.getCSSName()+"-keyframes"]);d.push(g);e=l("  %sanimation-delay: %sms;",[b,e]);d.push(e);b=l("  %sanimation-fill-mode: forwards;",[b]);d.push(b);c=d.join("\n");f.push(c)});return l(h,[a.getCSSName(),f.join("\n")])}var m=e.util.VENDOR_PREFIXES={microsoft:"-ms-",mozilla:"-moz-",opera:"-o-",w3:"",webkit:"-webkit-"},n="@%skeyframes %s-keyframes {\n%s\n}",h=".%s {\n  position: absolute;\n%s\n}";j.Kapi.prototype.toCSS=function(a){var a=a||{},d=[],f=this.getActorIds();_.each(f,function(c){d.push(this.getActor(c).toCSS(a))},
this);return d.join("\n")};j.Kapi.Actor.prototype.toCSS=function(a){var a=a||{},d=[],f=a.granularity||100,c=k(this,a.vendors);d.push(c);for(var c=this.getLength(),b=this.getStart(),e=[],h,j=c/f,l=c/100,f=b;f<=c+b;f+=j)this.calculatePosition(f),h=(f-b)/l,h=0===h?"from ":100===h?"to ":h.toFixed(2)+"% ",e.push("  "+h+g(this));c=e.join("\n");a=i(c,this.getCSSName(),a.vendors);d.push(a);return d.join("\n")};var l=e.util.printf=function(a,d){var e=a;_.each(d,function(a){e=e.replace("%s",a)});return e}})(this.Rekapi,
this);
